#!/bin/sh
# Marathon Shell Wayland Session Startup Script
# Sets up environment and launches the shell

# Set session name
export XDG_SESSION_TYPE=wayland
export XDG_SESSION_DESKTOP=marathon
export XDG_CURRENT_DESKTOP=marathon

# Marathon-specific paths
export MARATHON_PREFIX=/usr
export MARATHON_APPS_DIR=~/.local/share/marathon-apps

# Qt/QML environment - DO NOT set QT_QPA_PLATFORM for a Wayland compositor
# The shell IS the compositor, not a client. Qt will auto-select the correct backend.
# export QT_QPA_PLATFORM=wayland  # WRONG - causes crash
export QT_WAYLAND_DISABLE_WINDOWDECORATION=1
export QT_QUICK_CONTROLS_STYLE=Basic
export QML_IMPORT_PATH=/usr/lib/qml:$QML_IMPORT_PATH
export QML2_IMPORT_PATH=/usr/lib/qml:$QML2_IMPORT_PATH

# Display scaling for OnePlus 6 (1080x2280, ~402 DPI)
export QT_SCALE_FACTOR=1
export QT_AUTO_SCREEN_SCALE_FACTOR=0
export QT_SCREEN_SCALE_FACTORS=1
export QT_ENABLE_HIGHDPI_SCALING=0

# Wayland environment
export WAYLAND_DISPLAY=wayland-0
export XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-/run/user/$(id -u)}

# D-Bus session
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
    eval $(dbus-launch --sh-syntax --exit-with-session)
fi

# Enable debug logging if requested
if [ "$MARATHON_DEBUG" = "1" ]; then
    export QT_LOGGING_RULES="*.debug=true;marathon.*.info=true"
else
    export QT_LOGGING_RULES="*.warning=true;marathon.*.info=true"
fi

# Performance: Disable QML AOT compilation (causes slowdowns and excessive temp files)
export QML_DISABLE_DISK_CACHE=0
export QT_QUICK_CONTROLS_IMAGINE_PATH=""
export QML_DISABLE_OPTIMIZER=0

# Use QML cache for faster startup
export QML_FORCE_DISK_CACHE=1

# Accessibility - disable AT-SPI bridge (causes issues on minimal systems)
export NO_AT_BRIDGE=1
export GTK_A11Y=none
export QT_ACCESSIBILITY=0

# GIO/GSettings - use memory backend if no dconf
export GIO_USE_VFS=local
export GSETTINGS_BACKEND=memory

# Start the compositor
exec /usr/bin/marathon-shell-bin "$@"
